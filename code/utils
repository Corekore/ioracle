##############################################################################
# Define functions that are used in other scripts
#
# Use: source /path/to/this/file/utils
#
##############################################################################


# This function executes a command for X seconds
# Usage:
#    executeCommandUntilKeyPressed $command
#
function executeCommandUntilKeyPressed() {
  cmd=$1
  $cmd&

  cmdpid=$!
  read -rsp $'Please use device. Press any key once you completed scenario...\n' -n1 key

  if [ -d /proc/$cmdpid ]
  then
    kill $cmdpid
  fi
}


# This function parses the output from filemon and creates prolog facts that
# contains the mapping of process-file-operationType
# Operations type: Create, Chown, Modify, Rename, Change stat, Delete, Create dir,
# Usage:
#    logFileAccessFacts $user $host $port $directoryForOutput/filemonRawOutput.txt
#
function logFileAccessFacts() {
  user="$1"
  host="$2"
  port="$3"
  filemonRawOutput="$4"
  IFS=$'\n'

  for fileAccessEntry in $(cat $filemonRawOutput); do
    processId=`echo $fileAccessEntry | awk '{print $1}'`
    processName=`echo $fileAccessEntry | awk '{print $2}'`

    # Get path to the binary that started the process
    pathToProcessExecutable=`ssh -p $port -n $user@$host ps -p $processId -o comm | sed -n 2p`
    operationType=`echo $fileAccessEntry | awk '{print $3}'`
    pathToSourceFile=`echo $fileAccessEntry | awk '{print $4}'`
    pathToDestinationFile=`echo $fileAccessEntry | awk '{print $5}'`

    # Operation with multiple words; ex:"Changed xattr/stat"
    if [ $operationType == "Changed" ]; then
      operationType=`echo $fileAccessEntry | awk '{print $3" "$4}'`
      pathToSourceFile=`echo $fileAccessEntry | awk '{print $5}'`
      pathToDestinationFile=`echo $fileAccessEntry | awk '{print $6}'`
    fi

    # Destination file does not exist -> write dummy text
    if [[ -z $pathToDestinationFile ]]; then
      pathToDestinationFile=`echo No destination`
    fi

    # Write the facts to file
    echo "fileAccessObservation(process(\"$pathToProcessExecutable\"),sourceFile(\"$pathToSourceFile\"),destinationFile(\"$pathToDestinationFile\"),operation(\"$operationType\"))."

  done
}
